<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="iris-ticket-caller">
  <template>
    <style>
      :host {
        display: block;
        font-size: 42px;
      }
      
      iron-icon {
        width: 60px;
        height: 60px;
        background-color: var(--mydoc-brown-400);
        border-radius: 50%;
        color: white;
        margin-right: 20px;
      }
      
      .labels > div {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
      }
      
      .labels > div > span {
        margin-right: 20px;
      }
      
      span {
        width: 200px;
      }
      
      span.label {
        min-height: 70px;
        text-align: center;
      }
      
      .client {
        margin-bottom: 30px;
      }
      
      .client-id {
        color: var(--iris-ticket-caller-ticket-color, --default-primary-color);
      }
      
      .operator-id {
        color: var(--iris-ticket-caller-operator-color, --default-primary-color);
      }
    </style>

    <iris-settings-access id="settings"></iris-settings-access>
    <iris-roomdisplay id="roomdisplay" ticket-to-play="{{ticket}}"></iris-roomdisplay>
    <audio id="audio" src="{{ src }}" on-loadeddata="onCanPlay" on-ended="onMediaEnd"></audio>
    <div orientation$="{{orientation}}" class="labels">

      <div class="client">
        <span class="label-text"><iron-icon icon="expand-more"></iron-icon>Клиент</span>
        <span class="label client-id">[[current.label]]</span>
      </div>

      <div class="operator">
        <span class="label-text"><iron-icon icon="expand-more"></iron-icon>Окно</span>
        <span class="label operator-id">[[current.operator.short_label]]</span>
      </div>

    </div>

  </template>
  <script>
    'use strict'
    Polymer({
      is: 'iris-ticket-caller',
      properties: {
        ticket: {
          type: Object,
          observer: 'ticketUpdate'
        },
        isPlaying: {
          type: Boolean
        },
        orientation: {
          type: String,
          value: "horizontal"
        }
      },
      ticketUpdate(ticket) {
        if (!ticket || !(ticket instanceof IRIS.Ticket)) return;
        console.log('ticket to play', ticket.id);
        this.current = ticket;
        let server = this.$.settings.getItem('api_server');
        this.src = 'http://' + server + '/' + ticket.voice;
        console.log(this.src);
        this.debounce('voice-failed', () => this.onMediaFailed(), ticket.voice_duration);
        console.log('duration', ticket.voice_duration);
        console.log('readyState', this.$.audio.readyState);
        if (this.$.audio.readyState >= 2) {
          console.log('can play');
          this.play();
        }
      },
      onMediaFailed() {
        if (this.ticket) this.$.roomdisplay.failed(this.ticket).then(() => {
          console.log('failed!');
          this.set('isPlaying', false);
        });
      },
      onMediaEnd() {
        if (this.ticket) this.$.roomdisplay.played(this.ticket).then(() => {
          console.log('played!');
          this.set('isPlaying', false);
        });
      },
      onCanPlay() {
        this.play();
      },
      play() {
        this.cancelDebouncer('voice-failed');
        this.$.audio.play();
        this.set('isPlaying', true);
      },
      call(to_play) {
        let ticket = to_play.ticket;
        let sound = to_play.sound;

      }
    });
  </script>
</dom-module>